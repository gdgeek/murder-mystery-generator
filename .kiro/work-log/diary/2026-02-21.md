# 工作日记 2026-02-21

## 今日概要

今天是一个高产的功能开发日，核心工作围绕"角色优先两阶段生成"系统展开。从需求分析、技术设计到完整实现和端到端验证，一天内完成了角色系统的全生命周期搭建，包括类型定义、数据库迁移、两阶段生成引擎、角色持久化与复用、前端 UI 适配，以及后续的角色系统重构和沉浸式叙事功能的 spec 创建与实现。

## 完成事项

- 创建了 character-first-generation 功能的完整 spec（需求文档、设计文档、任务计划）
- 经过多轮用户反馈迭代需求：角色持久化三层表结构、外貌描述、角色类型区分、性别/血型/MBTI 字段
- 执行了全部 14 个实现任务：类型定义、MySQL 迁移（006/007）、Redis 存储、两阶段提示词与解析、状态机编排、5 个角色 API 路由、向后兼容、角色 CRUD、反馈优化等
- 通过 API 端到端验证了角色优先模式：生成民国谍战主题剧本「霞飞路凶影」，5 个角色成功持久化
- 在服务器内嵌 UI（body.html + app.js）中新增角色列表 tab、角色详情、生成模式选择、角色审查组件
- 排查并修复了角色列表不显示的两个 bug（querySelector vs querySelectorAll、HTML 嵌套结构错误）
- 删除了多余的 Vite SPA 前端（packages/web/）
- 合并了"模式"和"生成方式"两个下拉框为统一的「生成模式」选择框（staged/vibe/character_first）
- 完成角色系统重构（迁移 008）：characters 表去除 character_type/birthday、新增 zodiac_sign；abilities 和剧本绑定数据移入 script_character_sets
- 修复了 LLM 生成重复 ID 导致角色无法持久化的问题（用 UUID 替换 LLM 生成的 ID）
- 完成第二次重构（迁移 009）：abilities 从 characters 移到 script_character_sets，移除 tags
- 将角色系统更新同步到 design-kb 知识库（README、design.md、样例 JSON）
- 发布 @gdgeek/murder-mystery-shared@1.1.0 到 GitHub Packages
- 提交并推送了 design-kb 子模块和主仓库的所有变更
- 创建了 character-narrative-stories 功能的完整 spec（需求、设计、任务计划），支持第二人称沉浸式叙事
- 执行了叙事功能全部 8 个实现任务：类型扩展、提示词注入、校验方法、向后兼容、迁移工具更新
- 端到端验证叙事功能，发现 LLM 在大型 JSON 中倾向压缩叙事内容，需后续拆分为独立调用

## 涉及模块

- `.kiro/specs/character-first-generation/` — 角色优先生成功能 spec（需求、设计、任务）
- `.kiro/specs/character-narrative-stories/` — 沉浸式叙事功能 spec（需求、设计、任务）
- `packages/shared/src/types/script.ts` — CharacterProfile 类型定义、ScriptCharacterBinding、叙事字段扩展
- `packages/server/src/services/generator.service.ts` — 两阶段生成引擎、角色持久化、UUID 修复、叙事提示词注入
- `packages/server/src/services/generator.service.test.ts` — 测试断言适配
- `packages/server/src/routes/characters.ts` — 角色 CRUD API（POST/GET/PUT）
- `packages/server/src/routes/scripts.ts` — 剧本生成 API 扩展
- `packages/server/src/db/migrations/006~009` — 四个数据库迁移（角色表、关联表、重构、abilities 迁移）
- `packages/server/src/routes/ui/body.html` + `app.js` — 内嵌 UI（角色列表、审查、生成模式合并）
- `packages/server/src/services/migration.service.ts` — 迁移工具叙事兼容更新
- `packages/web/` — 已删除（Vite SPA 前端）
- `design-kb/` — 知识库同步（README、design.md、样例 JSON）
- `packages/shared/package.json` — shared 包版本升级至 1.1.0

## 工作评价

这是一个极其高效的开发日，从零开始完成了角色系统的完整生命周期——需求分析、设计、实现、验证、重构、知识库同步、包发布、git 提交，还额外完成了沉浸式叙事功能的 spec 和实现。

做得好的地方：
- 需求迭代节奏很好，每次用户提出新想法（持久化、外貌、MBTI、重构）都能快速融入现有设计，没有推倒重来
- 14 个实现任务一次性执行完毕，634 个测试全部通过，代码质量稳定
- 角色系统经历了两次重构（008、009 迁移），每次都保持了向后兼容和测试通过，说明架构弹性不错
- UUID 替换 LLM ID 的修复方案简洁有效，抓住了根本原因（INSERT IGNORE + 重复 ID）
- 一天内完成了两个完整功能的 spec + 实现，产出量很高

不足之处：
- 角色列表不显示的问题排查了三轮（querySelector、缓存、HTML 嵌套），说明内嵌 UI 的代码质量和可维护性较差，手写 HTML/JS 容易出现结构性错误
- 角色系统在同一天内经历了两次数据库重构（008、009），说明初始设计时对"通用角色属性 vs 剧本绑定属性"的边界划分不够清晰
- 沉浸式叙事的端到端验证暴露了 LLM 在大型 JSON 中压缩内容的问题，这个风险在设计阶段应该被预见到
- 工作时间跨度较长（14:30 ~ 24:30），持续 10 小时的高强度开发可能影响后续状态

## 改进建议

- 内嵌 UI 的 HTML/JS 手写方式已经多次出现结构性 bug，建议引入轻量模板引擎或组件化方案（如 lit-html），减少手动 DOM 操作的出错概率
- 数据库表结构设计时，先明确"实体固有属性"和"关系绑定属性"的边界，画 ER 图确认后再建表，避免短期内反复迁移
- 对于 LLM 生成大型 JSON 时内容被压缩的问题，应在设计阶段就规划"叙事内容独立生成"的方案，而非依赖单次调用生成所有内容
- 单日工作时间控制在 8 小时以内，超长开发容易引入低级错误（如 querySelector 问题可能就是疲劳导致）
- 角色 ID 生成策略应在设计文档中明确规定使用 UUID，而非依赖 LLM 输出后再修复

## 备注

- LLM 在生成大型 JSON（含多角色、多幕、多线索）时，会主动压缩文本字段以节省 token。沉浸式叙事（要求 300+ 字）在单次生成中几乎不可能达标，需要拆分为独立的叙事生成调用
- `INSERT IGNORE` + LLM 生成的简单 ID（p001/p002）会导致不同剧本的角色互相覆盖。解决方案是在确认角色时用 UUID 替换 LLM ID，并同步更新 relationships 中的引用
- 内嵌 UI 中 `querySelector` 返回单个元素而 `querySelectorAll` 返回 NodeList，混用会导致 `.forEach` 报错但不会抛出明显异常，排查困难
- HTML 中重复的 `id` 属性不会报错但会导致 CSS/JS 选择器行为异常，嵌套的隐藏父容器会使子元素不可见即使子元素本身 display 正常
